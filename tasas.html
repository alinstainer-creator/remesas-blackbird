<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackbird Tasas del D√≠a</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      color: #2c3e50;
      font-family: 'Roboto', 'Noto Color Emoji', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 1080px;
      height: 1920px;
      background: #f8f9fa; /* Fondo m√°s suave, no blanco puro */
      border: 1px solid #cbd5e0;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #edf2f7;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .header h1 {
      font-size: 2.5rem;
      color: #1a202c;
      font-weight: 700;
      margin: 0;
    }
    .header .download-btn {
      background: #3182ce;
      color: #ffffff;
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .header .download-btn:hover {
      background: #2b6cb0;
    }
    .header .logo {
      width: 70px;
      height: auto;
    }
    #tabla-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px; /* Reducido gap para m√°s espacio vertical */
      padding: 10px;
      height: 1600px; /* Ajustado para que quepan todas sin desbordar */
    }
    .rate-box {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 15px;
      padding: 10px; /* Reducido padding para compactar */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
    }
    .rate-box:hover {
      transform: translateY(-3px);
    }
    .rate-label {
      color: #4a5568;
      font-size: 1.2rem; /* Aumentado para legibilidad */
      font-weight: 400;
      margin-bottom: 6px; /* Reducido margen */
      display: flex;
      align-items: center;
      gap: 6px;
      text-align: center;
    }
    .rate-value {
      font-size: 2rem; /* Aumentado para que las tasas sean grandes y visibles */
      font-weight: 700;
      color: #3182ce;
      background: #ebf8ff;
      padding: 6px 12px; /* Ajustado para no ocupar mucho espacio */
      border-radius: 10px;
    }
    .cta {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      color: #4a5568;
      font-weight: 500;
    }
    .error {
      color: #e53e3e;
      text-align: center;
      margin: 20px 0;
      font-size: 1.1rem;
    }
    @media (max-width: 1080px) {
      .container { width: 100%; height: 1920px; }
      .header h1 { font-size: 2rem; }
      .header .logo { width: 60px; }
      #tabla-container { gap: 8px; height: 1700px; }
      .rate-label { font-size: 1.1rem; }
      .rate-value { font-size: 1.8rem; }
      .cta { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="./logo blackbird.png" alt="Blackbird Logo" class="logo">
      <h1>TASA DEL D√çA</h1>
      <button class="download-btn" onclick="descargarTabla()">Descargar</button>
    </div>
    <div id="tabla-container"></div>
    <div id="error-message" class="error"></div>
    <div class="cta">¬°Cont√°ctanos para tu remesa!</div>
  </div>
  <script type="text/babel">
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT9Teo-_5ka3LKx7FXL3x3yV3uf4KhoI61ewnVJyJ90XRnksoObf4CDn-lJvrFKiQ/pub?gid=983978085&single=true&output=csv';

    const formatNumber = (number) => {
      if (number === null || isNaN(number)) return 'N/A';
      const absNumber = Math.abs(number);
      const decimalPlaces = absNumber > 10 ? 2 : 4;
      return number.toLocaleString('es-CL', {
        minimumFractionDigits: decimalPlaces,
        maximumFractionDigits: decimalPlaces
      });
    };

    const cleanRate = (raw) => {
      if (!raw || typeof raw !== 'string') return null;
      let cleaned = raw.replace(/[$BsCOPARSCLPMXN‚Ç¨S\/.]/g, '').replace(/\s/g, '').trim().replace(/,/g, '.');
      const parsed = parseFloat(cleaned);
      return isNaN(parsed) ? null : parsed;
    };

    const currencyToFlag = {
      ARS: 'üá¶üá∑', VES: 'üáªüá™', CLP: 'üá®üá±', USD: 'üá∫üá∏', MXN: 'üá≤üáΩ', PEN: 'üáµüá™',
      COP: 'üá®üá¥', EUR: 'üá™üá∏', ECU: 'üá™üá®'
    };

    const desiredPairs = [
      { origin: 'Chile', dest: 'Venezuela', originCur: 'CLP', destCur: 'VES' },
      { origin: 'USA', dest: 'Venezuela', originCur: 'USD', destCur: 'VES' },
      { origin: 'USA', dest: 'Chile', originCur: 'USD', destCur: 'CLP' },
      { origin: 'Chile', dest: 'USA', originCur: 'CLP', destCur: 'USD' },
      { origin: 'Chile', dest: 'Colombia', originCur: 'CLP', destCur: 'COP' },
      { origin: 'Colombia', dest: 'Chile', originCur: 'COP', destCur: 'CLP' },
      { origin: 'Per√∫', dest: 'Venezuela', originCur: 'PEN', destCur: 'VES' },
      { origin: 'Chile', dest: 'Per√∫', originCur: 'CLP', destCur: 'PEN' },
      { origin: 'Argentina', dest: 'Venezuela', originCur: 'ARS', destCur: 'VES' },
      { origin: 'Chile', dest: 'Argentina', originCur: 'CLP', destCur: 'ARS' },
      { origin: 'M√©xico', dest: 'Venezuela', originCur: 'MXN', destCur: 'VES' },
      { origin: 'Chile', dest: 'M√©xico', originCur: 'CLP', destCur: 'MXN' },
      { origin: 'Colombia', dest: 'Venezuela', originCur: 'COP', destCur: 'VES' },
      { origin: 'Espa√±a', dest: 'Venezuela', originCur: 'EUR', destCur: 'VES' },
      { origin: 'Chile', dest: 'Espa√±a', originCur: 'CLP', destCur: 'EUR' },
      { origin: 'Chile', dest: 'Ecuador', originCur: 'CLP', destCur: 'ECU' }
    ];

    async function loadFileData() {
      try {
        const response = await fetch(CSV_URL, { method: 'GET', headers: { 'Accept': 'text/csv' } });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.text();
      } catch (error) {
        console.error('Error al cargar el CSV:', error);
        return null;
      }
    }

    function ExchangeRateTable() {
      const [rates, setRates] = React.useState([]);
      const [error, setError] = React.useState('');

      React.useEffect(() => {
        loadFileData().then(csv => {
          if (csv) {
            Papa.parse(csv, {
              skipEmptyLines: true,
              transform: (value) => value.trim().replace(/^"|"$/g, ''),
              complete: (results) => {
                const exchangeRates = {};
                results.data.forEach((row, index) => {
                  if ((index - 3) % 9 === 0 && index >= 3) {
                    const b = row[1] ? String(row[1].trim()) : '';
                    const c = row[2] ? String(row[2].trim()) : '';
                    const d = row[3] ? String(row[3].trim()) : '';
                    const combined = `${b} ${c} ${d}`.replace(/\u00A0/g, ' ').trim();
                    const cleanCombined = combined.replace(/[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
                    const pairText = cleanCombined.replace('COTIZACION MESA ', '').trim();
                    const parts = pairText.split('-').map(s => s.trim().toUpperCase()).filter(Boolean);

                    if (parts.length >= 2) {
                      let origin = parts[0];
                      let dest = parts[1];
                      origin = origin === 'USA' ? 'USD' : origin;
                      dest = dest === 'VZLA' ? 'VES' : dest;
                      dest = dest === 'MEXICO' ? 'MXN' : dest;
                      dest = dest === 'PERU' ? 'PEN' : dest;

                      const originCurrency = countryCodeToCurrency[origin] || countryCodeToCurrency[origin.replace(/\W/g, '')] || origin;
                      const destCurrency = countryCodeToCurrency[dest] || countryCodeToCurrency[dest.replace(/\W/g, '')] || dest;
                      const pairKey = `${originCurrency}/${destCurrency}`;
                      
                      const rateRow = results.data[index + 3];
                      if (rateRow) {
                        const rawRate = rateRow[5] || rateRow[6] || ''; 
                        const parsedRate = cleanRate(rawRate);
                        if (parsedRate !== null) {
                          exchangeRates[pairKey] = parsedRate;
                        }
                      }
                    }
                  }
                });

                const rateList = desiredPairs.map(pair => {
                  const pairKey = `${pair.originCur}/${pair.destCur}`;
                  const rate = exchangeRates[pairKey] || null;
                  return {
                    origin: pair.origin || '',
                    dest: pair.dest || '',
                    rate: rate ? formatNumber(rate) : 'N/A',
                    originFlag: currencyToFlag[pair.originCur] || '',
                    destFlag: currencyToFlag[pair.destCur] || ''
                  };
                });
                setRates(rateList);
              },
              error: (err) => setError('Error al parsear el CSV: ' + err.message),
            });
          } else {
            setError('Error al cargar el CSV.');
          }
        });
      }, []);

      React.useEffect(() => {
        if (error) {
          document.getElementById('error-message').innerText = error;
        }
      }, [error]);

      return (
        <React.Fragment>
          {rates.map((rate, index) => (
            <div key={index} className="rate-box">
              <div className="rate-label">
                {rate.originFlag} {rate.origin} - {rate.destFlag} {rate.dest}
              </div>
              <div className="rate-value">{rate.rate}</div>
            </div>
          ))}
        </React.Fragment>
      );
    }

    const currencyToCountry = {
      ARS: 'Argentina', VES: 'Venezuela', CLP: 'Chile', USD: 'USA', MXN: 'M√©xico',
      PEN: 'Per√∫', COP: 'Colombia', EUR: 'Espa√±a', ECU: 'Ecuador'
    };

    const countryCodeToCurrency = {
      'ARG': 'ARS', 'AR': 'ARS', 'ARGENTINA': 'ARS', 'ARGEN': 'ARS', 'ARGNT': 'ARS',
      'PESO ARG': 'ARS', 'PESO ARGENTINO': 'ARS', 'ARG$': 'ARS', 'ARS': 'ARS',
      'VEN': 'VES', 'VZLA': 'VES', 'VENEZUELA': 'VES', 'VENEZ': 'VES', 'VZL': 'VES',
      'BOLIVAR': 'VES', 'BOL√çVAR': 'VES', 'VES$': 'VES', 'VES': 'VES',
      'CHILE': 'CLP', 'CHL': 'CLP', 'PESO CHILENO': 'CLP', 'CLP$': 'CLP', 'CHI': 'CLP', 'CLP': 'CLP',
      'USA': 'USD', 'US': 'USD', 'ESTADOS UNIDOS': 'USD', 'DOLLAR': 'USD', 'D√ìLAR': 'USD', 'USD$': 'USD', 'USD': 'USD',
      'MEX': 'MXN', 'M√âXICO': 'MXN', 'MEXICO': 'MXN', 'PESO MEX': 'MXN', 'PESO MEXICANO': 'MXN', 'MX$': 'MXN', 'MXN': 'MXN',
      'PERU': 'PEN', 'PER√ö': 'PEN', 'PER': 'PEN', 'SOL': 'PEN', 'SOLES': 'PEN', 'PEN$': 'PEN', 'PEN': 'PEN',
      'COP': 'COP', 'COL': 'COP', 'COLOMBIA': 'COP', 'PESO COL': 'COP', 'PESO COLOMBIANO': 'COP', 'COL$': 'COP', 'COP': 'COP',
      'EUR': 'EUR', 'EURO': 'EUR', 'EUROPA': 'EUR', 'EUROZONA': 'EUR', '‚Ç¨': 'EUR', 'ESP': 'EUR', 'ESPA√ëA': 'EUR',
      'ECU': 'ECU', 'ECUADOR': 'ECU', 'EC': 'ECU', 'D√ìLAR ECU': 'ECU', 'USD ECU': 'ECU', 'ECU': 'ECU'
    };

    const root = ReactDOM.createRoot(document.getElementById('tabla-container'));
    root.render(<ExchangeRateTable />);

    function descargarTabla() {
      const container = document.querySelector('.container');
      const downloadBtn = document.querySelector('.download-btn');
      downloadBtn.style.display = 'none';
      html2canvas(container, {
        backgroundColor: '#f8f9fa',
        width: 1080,
        height: 1920,
        scale: 4,
        useCORS: true
      }).then(canvas => {
        downloadBtn.style.display = '';
        const link = document.createElement('a');
        link.download = 'tasa_del_dia.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
      }).catch(err => {
        downloadBtn.style.display = '';
        console.error('Error al generar la imagen:', err);
        document.getElementById('error-message').innerText = 'Error al descargar la imagen. Intenta de nuevo.';
      });
    }
  </script>
</body>
</html>
