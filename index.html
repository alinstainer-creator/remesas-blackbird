<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blackbird SR-71 ‚Äî Calculadora de Remesas (Premium)</title>
<meta name="description" content="Calculadora Blackbird SR-71 - lectura directa desde Google Sheet (Venta IMAD), calculo y pedido por Telegram." />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#00b4ff;
    --accent-dark:#0077cc;
    --bg:#000; 
    --panel:#0b0b0b;
    --muted:#9fbfdc;
    --glass: rgba(0,180,255,0.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:#e6f3ff; font-family:'Roboto Condensed',sans-serif}
  .page { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px; }
  .wrap { width:100%; max-width:1100px; border-radius:14px; position:relative; overflow:hidden; padding:26px; background: linear-gradient(180deg,#070708 0%, #0b0b0c 60%); box-shadow:0 20px 60px rgba(0,0,0,0.9); border:1px solid rgba(0,180,255,0.06) }
  /* radar canvas behind */
  canvas#bgRadar { position:absolute; inset:0; width:100%; height:100%; z-index:0; opacity:0.12; filter:blur(0.6px); }
  header { position:relative; z-index:2; text-align:center; padding-bottom:12px }
  .logo { width:120px; height:120px; object-fit:cover; border-radius:50%; border:3px solid var(--accent); box-shadow:0 8px 30px rgba(0,180,255,0.12); margin:0 auto 10px }
  h1{ margin:0; font-family:'Orbitron', monospace; color:var(--accent); font-weight:700; letter-spacing:2px; font-size:26px; text-shadow:0 0 12px rgba(0,180,255,0.12) }
  p.lead{ margin:6px 0 0; color:var(--muted); font-size:13px }

  /* main */
  .grid { display:grid; grid-template-columns: 1fr 420px; gap:20px; align-items:start; position:relative; z-index:2; margin-top:16px }
  @media(max-width:940px){ .grid{ grid-template-columns: 1fr; } }

  /* left - calculator */
  .panel { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.03); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02) }
  label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; text-transform:uppercase; font-weight:700 }
  .row { display:flex; gap:12px; margin-bottom:12px; }
  .col { flex:1 }
  select,input { width:100%; padding:12px 13px; background:#080809; color:#e6f3ff; border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-size:15px }
  select:focus, input:focus { outline:none; box-shadow:0 6px 20px rgba(0,180,255,0.08); border-color:var(--accent) }
  .muted { color:var(--muted); font-size:13px; margin-bottom:8px }

  .actions { display:flex; gap:12px; margin-top:10px }
  .btn { flex:1; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:800; letter-spacing:0.6px; border:none }
  .btn-primary { background:linear-gradient(90deg,var(--accent),var(--accent-dark)); color:#02101a; box-shadow:0 8px 26px rgba(0,180,255,0.14); }
  .btn-outline { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }
  .btn-primary:active{ transform:translateY(2px) }

  #resultado { margin-top:14px; padding:12px; border-radius:10px; background:var(--glass); border:1px solid rgba(0,180,255,0.08); font-weight:700; color:#e9fbff; min-height:54px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap }
  .res-left { font-size:15px; color:#e9fbff }
  .res-right { font-family:'Orbitron',monospace; color:var(--accent); font-size:20px }

  /* right - table / info */
  .side { padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border:1px solid rgba(255,255,255,0.02) }
  .side h3 { margin:0 0 8px 0; color:var(--accent); font-family:'Orbitron' }
  table { width:100%; border-collapse:collapse; font-size:13px; color:#dff4ff }
  th,td { padding:8px 10px; text-align:left }
  th { background:linear-gradient(90deg,var(--accent),var(--accent-dark)); color:#02101a; font-weight:800; font-size:12px }
  tbody tr:hover { background:rgba(0,180,255,0.03) }

  footer { margin-top:18px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap }
  .small { color:var(--muted); font-size:12px }

  /* subtle animations */
  .pulse { animation:pulse 2.6s infinite; }
  @keyframes pulse { 0%{ transform:scale(1) } 50%{ transform:scale(1.005) } 100%{ transform:scale(1) } }

  /* mobile tweaks */
  @media(max-width:520px){
    h1{ font-size:20px }
    .res-right { font-size:18px }
    .grid{ gap:14px }
  }
</style>
</head>
<body>
<div class="page">
  <div class="wrap">
    <canvas id="bgRadar"></canvas>

    <header>
      <img src="logo blackbird.png" alt="Blackbird logo" class="logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/120/00b4ff/071017?text=SR-71'">
      <h1>Blackbird SR-71 ‚Äî Remesas (Premium)</h1>
      <p class="lead">R√°pido, m√≥vil y seguro ‚Äî selecciona pa√≠s origen y destino, ingresa monto en moneda local y calcula al instante.</p>
    </header>

    <div class="grid">
      <!-- LEFT: calculator -->
      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div>
            <div style="font-size:13px;color:var(--muted);font-weight:800">Calculadora Mach 3</div>
            <div style="font-size:12px;color:#9fbfdc;margin-top:2px">Basado en tasas VENTA IMAD (sheet)</div>
          </div>
          <div style="font-size:12px;color:var(--muted)">v1.0</div>
        </div>

        <div class="muted">Origen ‚Üí Destino</div>
        <div class="row">
          <div class="col">
            <label for="selOrigen">Pa√≠s de Origen</label>
            <select id="selOrigen"><option value="">Cargando...</option></select>
          </div>
          <div style="width:12px"></div>
          <div class="col">
            <label for="selDestino">Pa√≠s de Destino</label>
            <select id="selDestino"><option value="">Cargando...</option></select>
          </div>
        </div>

        <div style="margin-top:6px">
          <label for="monto">Monto (moneda local)</label>
          <input id="monto" type="number" step="0.01" placeholder="Ej. 1000" />
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="btnCalcular">Calcular</button>
          <button class="btn btn-outline" id="btnTelegram">Pedir por Telegram</button>
        </div>

        <div id="resultado">
          <div class="res-left">Resultado aparecer√° aqu√≠</div>
          <div class="res-right">--</div>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:13px">Si tu sheet est√° en modo lectura p√∫blica, la web podr√° leer las tasas; oc√∫palo en modo solo lectura para mayor seguridad.</div>
      </div>

      <!-- RIGHT: table -->
      <aside class="side">
        <h3>Tasas (Venta IMAD)</h3>
        <div style="max-height:420px;overflow:auto">
          <table id="ratesTable">
            <thead><tr><th>Origen</th><th>Destino</th><th style="text-align:right">Tasa</th></tr></thead>
            <tbody><tr><td colspan="3" style="color:var(--muted)">Cargando...</td></tr></tbody>
          </table>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="small">Contacto / Redes</div>
          <div style="display:flex;gap:8px">
            <a href="https://t.me/+i02VPMg23TNiOWJh" target="_blank" style="color:var(--accent)">‚úàÔ∏è</a>
            <a href="https://www.instagram.com/servicios_blackbird" target="_blank" style="color:var(--accent)">üì∏</a>
            <a href="https://www.tiktok.com/@remesasblackbird" target="_blank" style="color:var(--accent)">üéµ</a>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div class="small">¬© 2025 Blackbird SR-71 ‚Äî Experiencia Mach 3</div>
      <div class="small">Hecho para m√≥viles ‚Ä¢ F√°cil de usar</div>
    </footer>
  </div>
</div>

<!-- PapaParse CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
/* ===========================
   CONFIG: Cambia aqu√≠ si quieres
   =========================== */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3yMHp1HF-2JS1j0vNcp_snCjtTaWuF6y8AldyFGxbWvQrmhvisnagcBC1pWiskalafvz0EVY8svR6/pub?gid=983978085&single=true&output=csv';
const TELEGRAM_LINK = 'https://t.me/+i02VPMg23TNiOWJh'; // tu chat (preserva + si corresponde)
const RATE_ROW_MARKER = 'Venta IMAD'; // columna J indica esta etiqueta en la fila deseada
/* =========================== */

let rates = {};            // key: "Origen|||Destino" -> numeric price
let countrySet = new Set(); // unique countries (strings as appear in column D pairs)

/* helper: robust price parser */
function parsePrice(raw){
  if(raw === null || raw === undefined) return NaN;
  let s = String(raw).trim();
  if(s === '') return NaN;
  // remove currency symbols and spaces, but keep digits, dots and commas
  s = s.replace(/[^\d.,\-]/g,'').trim();
  // If contains both comma and dot, assume dot is decimal and commas are thousands -> remove commas
  if(s.indexOf(',') !== -1 && s.indexOf('.') !== -1){
    s = s.replace(/,/g,'');
  } else if(s.indexOf(',') !== -1 && s.indexOf('.') === -1){
    // only commas -> assume comma is decimal separator
    s = s.replace(/,/g,'.');
  }
  // remove leading/trailing non-numeric leftover
  s = s.replace(/^[^0-9\-]+|[^0-9]+$/g,'');
  const n = parseFloat(s);
  return isNaN(n) ? NaN : n;
}

/* helper: split pair strings like "Chile - USA" or "Chile - USA " or "Chile a USA" */
function splitPair(pairRaw){
  if(!pairRaw) return null;
  // Normalize common separators to " - "
  const normalized = pairRaw.trim().replace(/\s+/g,' ');
  // Split by variations: " - ", "-", "‚Äì", "‚Äî", " a ", " to "
  const parts = normalized.split(/\s*(?:[-‚Äì‚Äî]|(?:\sa\s)|(?:\sto\s))\s*/i).map(s=>s.trim()).filter(Boolean);
  if(parts.length >= 2) {
    // join only first two (ignore extra)
    return [parts[0], parts[1]];
  }
  // If can't split, maybe format "Chile/USA" etc.
  const alt = normalized.split(/[\/\\]/).map(s=>s.trim()).filter(Boolean);
  if(alt.length>=2) return [alt[0], alt[1]];
  return null;
}

/* formatting numbers nicely */
function fmt(n){
  if(isNaN(n)) return '--';
  // show with 2 decimals and thousands separators
  return Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}

/* load CSV and parse */
async function loadRatesFromSheet(){
  try{
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error('No se pudo cargar CSV (status ' + res.status + ')');
    const text = await res.text();
    Papa.parse(text, {
      header: false,
      skipEmptyLines: true,
      complete: function(results){
        processRows(results.data);
      }
    });
  }catch(e){
    console.error('Error fetching CSV:', e);
    // fallback example rates if anything falla
    rates = {
      'Chile|||USA': 852.75,
      'Chile|||Mexico': 0.0171,
      'Chile|||Venezuela': 0.2371
    };
    // ensure country set
    countrySet = new Set(['Chile','USA','Mexico','Venezuela']);
    populateSelects();
    renderRatesTable();
    showStatus('CARGA FALLIDA. Usando tasas de ejemplo', true);
  }
}

/* process parsed rows */
function processRows(rows){
  rates = {};
  countrySet = new Set();
  // rows is array of arrays
  rows.forEach((row, idx) => {
    // col J = index 9
    const colJ = row[9] ? String(row[9]).trim() : '';
    if(colJ && colJ.toLowerCase() === RATE_ROW_MARKER.toLowerCase()){
      // get pair from col D index 3, price from F (5) or G (6)
      const rawPair = row[3] ? String(row[3]).trim() : '';
      const priceCandidateF = row[5] !== undefined ? String(row[5]).trim() : '';
      const priceCandidateG = row[6] !== undefined ? String(row[6]).trim() : '';
      const pF = parsePrice(priceCandidateF);
      const pG = parsePrice(priceCandidateG);
      const price = !isNaN(pF) && pF !== 0 ? pF : (!isNaN(pG) && pG !== 0 ? pG : NaN);
      if(rawPair && !isNaN(price)){
        const pairParts = splitPair(rawPair);
        if(pairParts && pairParts.length >= 2){
          const from = pairParts[0];
          const to = pairParts[1];
          const key = `${from}|||${to}`;
          rates[key] = price;
          countrySet.add(from);
          countrySet.add(to);
        } else {
          // If pair not splittable, try to parse alternative separators
          // fallback: store full rawPair as single key (not ideal)
          // ignore for now
        }
      }
    }
  });

  if(Object.keys(rates).length === 0){
    // fallback example rates if sheet parsing returns none
    rates = {
      'Chile|||USA': 852.75,
      'Chile|||Mexico': 0.0171,
      'Chile|||Venezuela': 0.2371
    };
    countrySet = new Set(['Chile','USA','Mexico','Venezuela']);
    showStatus('No se encontraron filas "Venta IMAD" v√°lidas. Usando ejemplo de fallback', true);
  } else {
    showStatus('Tasas cargadas correctamente', false);
  }

  populateSelects();
  renderRatesTable();
}

/* populate selects */
function populateSelects(){
  const sO = document.getElementById('selOrigen');
  const sD = document.getElementById('selDestino');
  sO.innerHTML = '<option value="">Selecciona...</option>';
  sD.innerHTML = '<option value="">Selecciona...</option>';
  // sort alphabetically
  const arr = Array.from(countrySet).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
  arr.forEach(c=>{
    const optO = document.createElement('option'); optO.value = c; optO.textContent = c;
    const optD = optO.cloneNode(true);
    sO.appendChild(optO);
    sD.appendChild(optD);
  });
}

/* render rates table */
function renderRatesTable(){
  const tbody = document.querySelector('#ratesTable tbody');
  tbody.innerHTML = '';
  const keys = Object.keys(rates).sort();
  if(keys.length === 0){
    tbody.innerHTML = '<tr><td colspan="3" style="color:var(--muted)">No hay tasas cargadas</td></tr>';
    return;
  }
  keys.forEach(k=>{
    const [from,to] = k.split('|||');
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = from;
    const td2 = document.createElement('td'); td2.textContent = to;
    const td3 = document.createElement('td'); td3.style.textAlign='right'; td3.textContent = fmt(rates[k]);
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tbody.appendChild(tr);
  });
}

/* calculate */
function calcular(){
  const origen = document.getElementById('selOrigen').value;
  const destino = document.getElementById('selDestino').value;
  const montoRaw = document.getElementById('monto').value;
  const resBox = document.getElementById('resultado');
  if(!origen || !destino){
    showResultError('Selecciona origen y destino');
    return;
  }
  if(origen === destino){
    showResultError('Origen y destino deben ser diferentes');
    return;
  }
  const monto = Number(montoRaw);
  if(isNaN(monto) || monto <= 0){
    showResultError('Ingresa monto v√°lido (>0)');
    return;
  }
  const key = `${origen}|||${destino}`;
  const tasa = rates[key];
  if(tasa === undefined){
    showResultError('Ruta no disponible para este par');
    return;
  }
  const recibe = monto * tasa;
  // display nicely
  document.querySelector('#resultado .res-left').innerHTML = `${monto.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} (${origen}) ‚Üí recibe`;
  document.querySelector('#resultado .res-right').innerText = `${fmt(recibe)} (${destino})`;
  // small visual pulse
  const box = document.getElementById('resultado');
  box.classList.add('pulse');
  setTimeout(()=>box.classList.remove('pulse'),700);

  // store last calc for telegram
  window._lastCalc = {origen, destino, monto, recibe, tasa};
}

/* show error in result */
function showResultError(msg){
  document.querySelector('#resultado .res-left').innerHTML = `<span style="color:#ff8a8a">${msg}</span>`;
  document.querySelector('#resultado .res-right').innerText = '--';
}

/* telegram request */
function pedirTelegram(){
  const last = window._lastCalc;
  const selOrigen = document.getElementById('selOrigen').value;
  const selDestino = document.getElementById('selDestino').value;
  const monto = document.getElementById('monto').value;
  if(!selOrigen || !selDestino || !monto){
    alert('Completa origen, destino y monto antes de pedir el servicio.');
    return;
  }
  // prefer using last computed receive value, else compute now
  let recibeText = '';
  if(last && last.origen === selOrigen && last.destino === selDestino && Number(last.monto) === Number(monto)){
    recibeText = fmt(last.recibe);
  } else {
    // attempt compute ad-hoc
    const key = `${selOrigen}|||${selDestino}`;
    const tasa = rates[key];
    if(!tasa){ alert('Ruta no disponible'); return; }
    const recibe = Number(monto) * tasa;
    recibeText = fmt(recibe);
  }
  const msg = `Hola, quiero hacer el cambio:\nEnviar: ${Number(monto).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} (${selOrigen})\nRecibir: ${recibeText} (${selDestino})\nRuta: ${selOrigen} ‚Üí ${selDestino}\nTasa (Venta IMAD): ${rates[`${selOrigen}|||${selDestino}`]}\nGracias.`;
  // open telegram (uses your chat link)
  const href = TELEGRAM_LINK + '?text=' + encodeURIComponent(msg);
  window.open(href, '_blank');
}

/* simple status / toasts (console-like on top) */
function showStatus(msg, isError=false){
  console.log('STATUS:', msg);
  // optional: small browser toast? For now simply log and leave table updated
}

/* radar canvas background (subtle) */
(function radarAnim(){
  const canvas = document.getElementById('bgRadar');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = canvas.offsetWidth * devicePixelRatio; canvas.height = canvas.offsetHeight * devicePixelRatio; canvas.style.width = canvas.offsetWidth + 'px'; canvas.style.height = canvas.offsetHeight + 'px'; ctx.scale(devicePixelRatio, devicePixelRatio); }
  resize(); window.addEventListener('resize', ()=>{ resize(); });
  let t=0;
  function draw(){
    const w = canvas.offsetWidth;
    const h = canvas.offsetHeight;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // center radial lines
    const cx = w * 0.15; const cy = h * 0.2;
    // animated sweep
    for(let i=0;i<6;i++){
      const alpha = 0.03 + (i*0.01);
      ctx.beginPath();
      ctx.strokeStyle = `rgba(0,180,255,${alpha})`;
      ctx.lineWidth = 1;
      const r = 60 + i*60 + (t%120);
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();
    }
    // sweep sector
    ctx.beginPath();
    const ang = (t/20)%360 * Math.PI/180;
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,220, ang - 0.25, ang + 0.25);
    ctx.closePath();
    ctx.fillStyle = 'rgba(0,180,255,0.025)';
    ctx.fill();
    t += 0.9;
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

/* attach events */
document.getElementById('btnCalcular').addEventListener('click', calcular);
document.getElementById('btnTelegram').addEventListener('click', pedirTelegram);

/* init */
loadRatesFromSheet();
</script>
</body>
</html>
