<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blackbird SR-71 — Calculadora de Remesas (ULTRA)</title>
<meta name="description" content="Calculadora Blackbird: lectura robusta de Google Sheet (pares en columna D / precios en F-G fila siguiente). UI Cabina SR-71." />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  /* ---------- Base / Tipografía ---------- */
  :root{
    --bg:#040509;
    --panel:#07101a;
    --accent:#00b4ff;
    --accent-2:#0077cc;
    --muted:#9fbfdc;
    --glass: rgba(255,255,255,0.03);
    --hud: rgba(0,180,255,0.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#020308 60%);color:#e6f9ff;font-family:'Roboto Condensed',sans-serif;-webkit-font-smoothing:antialiased}
  /* ---------- Layout ---------- */
  .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
  .card{
    width:100%; max-width:1100px; border-radius:14px; position:relative; overflow:hidden;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border:1px solid rgba(255,255,255,0.02);
    box-shadow: 0 30px 80px rgba(0,0,0,0.85);
  }
  canvas#bg { position:absolute; inset:0; z-index:0; opacity:0.14; filter:blur(0.6px); }
  header{position:relative;z-index:2;padding:28px 34px;display:flex;gap:18px;align-items:center;border-bottom:1px solid rgba(255,255,255,0.02)}
  .logo{width:96px;height:96px;border-radius:50%;border:2px solid var(--accent);box-shadow:0 12px 40px rgba(0,180,255,0.06);object-fit:cover}
  .brand h1{font-family:'Orbitron',monospace;color:var(--accent);margin:0;font-size:20px;letter-spacing:1px}
  .brand p{margin:6px 0 0;color:var(--muted);font-size:13px}
  /* ---------- Main ---------- */
  .main{display:grid;grid-template-columns: 1fr 380px; gap:20px;padding:26px;position:relative;z-index:2}
  @media(max-width:980px){ .main{grid-template-columns:1fr} }
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.02)}
  /* form */
  label{display:block;color:var(--muted);font-weight:700;font-size:12px;margin-bottom:8px;text-transform:uppercase}
  .grid2{display:grid;grid-template-columns:1fr 1fr; gap:12px}
  .input, select{width:100%;padding:12px;border-radius:8px;background:rgba(10,12,16,0.6);border:1px solid rgba(255,255,255,0.03);color:#e9fbff;font-size:15px}
  .input:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 8px 28px rgba(0,180,255,0.06)}
  .controls{display:flex;gap:12px;margin-top:14px;align-items:center}
  /* small, refined buttons (not blocky) */
  .btn { padding:11px 16px;border-radius:10px;border:none;font-weight:800;font-family:'Orbitron',monospace;cursor:pointer; font-size:13px; letter-spacing:0.4px; }
  .btn-primary{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021018; box-shadow: 0 10px 30px rgba(0,180,255,0.12); }
  .btn-ghost{ background: transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
  .btn-tele{ background: linear-gradient(90deg,#2bd36b,#1ea64b); color:#05110a; }
  .btn:hover{ transform: translateY(-2px); }
  /* result HUD */
  .hud{ margin-top:14px; padding:14px; border-radius:10px; background: linear-gradient(180deg, rgba(0,180,255,0.03), rgba(255,255,255,0.01)); border:1px solid rgba(0,180,255,0.06); display:flex; align-items:center; justify-content:space-between; gap:12px; min-height:56px }
  .hud .left{ font-size:14px; color:#e8fbff }
  .hud .right{ font-family:'Orbitron',monospace; color:var(--accent); font-size:20px }
  /* side info */
  .side h3{margin:0 0 12px 0;color:var(--accent);font-family:'Orbitron',monospace;font-size:14px}
  table{width:100%;border-collapse:collapse;font-size:13px;color:#dff7ff}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02); text-align:left}
  th{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021018; font-weight:800;font-size:12px}
  tr:hover td{ background: rgba(0,180,255,0.02) }
  /* footer */
  footer{padding:18px;text-align:center;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.02)}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="page">
    <div class="card" role="main" aria-labelledby="title">
      <canvas id="bg"></canvas>

      <header>
        <img class="logo" src="logo blackbird.png" alt="Blackbird logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/96/00b4ff/071017?text=SR71'">
        <div class="brand">
          <h1 id="title">Blackbird SR-71 — Calculadora de Remesas</h1>
          <p class="small">Interfaz cabina • Lectura robusta de tu Google Sheet (Venta IMAD)</p>
        </div>
      </header>

      <main class="main">
        <!-- left: calculator -->
        <section class="panel" aria-label="Calculadora">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:800;color:var(--accent)">Calculadora Mach-3</div>
            <div class="small">Frontend • Sin backend</div>
          </div>

          <h2 style="font-family:Orbitron,monospace;color:var(--accent);margin:8px 0 18px 0;font-size:16px">Conversión entre países</h2>

          <div>
            <label for="selOrigen">País de origen</label>
            <select id="selOrigen" class="input" aria-label="País de origen"><option value="">Cargando países…</option></select>
          </div>

          <div style="margin-top:12px">
            <label for="selDestino">País de destino</label>
            <select id="selDestino" class="input" aria-label="País de destino"><option value="">Selecciona destino…</option></select>
          </div>

          <div style="margin-top:12px">
            <label for="monto">Monto (moneda local)</label>
            <input id="monto" class="input" type="number" inputmode="decimal" min="0" step="0.01" placeholder="Ej. 1000.00">
          </div>

          <div class="controls" style="margin-top:14px">
            <button id="btnCalc" class="btn btn-primary">CALCULAR</button>
            <button id="btnCopy" class="btn btn-ghost">Copiar resultado</button>
            <button id="btnTelegram" class="btn btn-tele">Pedir por Telegram</button>
          </div>

          <div class="hud" style="margin-top:14px" aria-live="polite">
            <div class="left" id="hudLeft">Resultado aparecerá aquí</div>
            <div class="right" id="hudRight">--</div>
          </div>

          <div style="margin-top:12px" class="small">Si no aparecen países, revisa que el documento esté publicado (Archivo → Publicar en la web) y que el CSV sea accesible.</div>
        </section>

        <!-- right: rates table -->
        <aside class="panel side" aria-label="Tasas">
          <h3>Tasas detectadas (Venta IMAD)</h3>
          <div style="max-height:520px; overflow:auto;">
            <table id="ratesTable" role="table" aria-describedby="ratesDesc">
              <thead><tr><th>Origen</th><th>Destino</th><th style="text-align:right">Tasa</th></tr></thead>
              <tbody><tr><td colspan="3" style="color:var(--muted);padding:18px">Cargando tasas desde sheet…</td></tr></tbody>
            </table>
          </div>

          <div style="margin-top:12px">
            <div class="small" id="ratesDesc">La tabla muestra pares y la tasa tomada de la fila marcada como "Venta IMAD" (valor en F o G en la fila siguiente al par).</div>
          </div>
        </aside>
      </main>

      <footer>
        <div>© 2025 Blackbird — Experiencia Mach-3</div>
      </footer>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
/* ================= CONFIG ================= */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3yMHp1HF-2JS1j0vNcp_snCjtTaWuF6y8AldyFGxbWvQrmhvisnagcBC1pWiskalafvz0EVY8svR6/pub?gid=983978085&single=true&output=csv';
const TELEGRAM_LINK = 'https://t.me/+i02VPMg23TNiOWJh';
/* ========================================= */

/* ---------- State ---------- */
let rates = {};     // nested: rates[origen] = { destino: price, ... }
let countries = new Set();
let rawPairs = [];  // raw pair strings (debug)

/* ---------- Helpers ---------- */
function cleanText(s){
  if(!s && s!==0) return '';
  return String(s).trim();
}
function removeDiacritics(str){ return str.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
function normalizeKey(s){ return removeDiacritics(String(s||'')).toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim(); }

function parsePrice(raw){
  if(raw === undefined || raw === null) return NaN;
  let s = String(raw).trim();
  if(!s) return NaN;
  s = s.replace(/\s/g,'');
  // keep digits, dots, comma, minus
  s = s.replace(/[^\d\.,\-]/g,'');
  if(s.indexOf(',') !== -1 && s.indexOf('.') !== -1){
    s = s.replace(/,/g,''); // comma likely thousands
  } else if(s.indexOf(',') !== -1 && s.indexOf('.') === -1){
    s = s.replace(/,/g,'.');
  }
  const n = parseFloat(s);
  return isNaN(n) ? NaN : n;
}

/* split pair robustly: supports ' - ', ' a ', ' to ', '/', '–','—' */
function splitPair(raw){
  if(!raw) return null;
  let p = String(raw).trim();
  // remove common labels and parentheses
  p = p.replace(/Cotizaci(o|ó)n Mesa/ig, '');
  p = p.replace(/Cotizacion/ig,'');
  p = p.replace(/\(.*?\)/g,'');
  p = p.replace(/[:]/g,'');
  // normalize whitespace
  p = p.replace(/\s+/g,' ').trim();
  // separators
  const parts = p.split(/\s*(?:[-–—\/\\]|(?:\sa\s)|(?:\sto\s)|[:])\s*/i).map(x=>x.trim()).filter(Boolean);
  if(parts.length>=2) return [parts[0], parts[1]];
  // fallback: try splitting by comma
  const alt = p.split(',').map(x=>x.trim()).filter(Boolean);
  if(alt.length>=2) return [alt[0], alt[1]];
  // nothing
  return null;
}

/* try find numeric price near row i in columns F (5) or G (6) within offset window */
function findNearbyPrice(rows, idx){
  const cols = [5,6]; // F, G indices
  const offsets = [1, 0, -1, 2, -2]; // prefer row+1, then same row, then above
  for(const off of offsets){
    const r = rows[idx + off];
    if(!r) continue;
    for(const c of cols){
      if(r[c]!==undefined && r[c]!==null && String(r[c]).trim()!==''){
        const p = parsePrice(r[c]);
        if(!isNaN(p) && p!==0) return {price:p, rowIndex: idx+off, col:c};
      }
    }
  }
  return null;
}

/* map short codes to nice names (extend as needed) */
const CODE_MAP = {
  'clp':'Chile','chi':'Chile','chl':'Chile',
  'ars':'Argentina','arg':'Argentina',
  'usd':'USA','usa':'USA',
  'pen':'Peru','penp':'Peru','penp':'Perú','penp':'Peru',
  'mxn':'Mexico','mex':'Mexico','mx':'Mexico',
  'ves':'Venezuela','ven':'Venezuela','ve':'Venezuela',
  'cop':'Colombia','col':'Colombia',
  'brl':'Brazil','bra':'Brazil','br':'Brazil',
  'eur':'España','esp':'España','espana':'España','spain':'España',
  'cad':'Canada','can':'Canada',
  'uyu':'Uruguay','uy':'Uruguay',
  'ecu':'Ecuador','ec':'Ecuador',
};

/* heuristics: if token like 'CLP' or 'CHI' map to Chile, else use token */
function canonicalizeCountry(token){
  if(!token) return token;
  const t = token.replace(/[^A-Za-z0-9]/g,'').trim();
  const k = t.toLowerCase();
  if(CODE_MAP[k]) return CODE_MAP[k];
  // if single 3-letter uppercase currency code style (like USD) map if known
  if(k.length===3 && CODE_MAP[k]) return CODE_MAP[k];
  // return original, cleaned (remove extra words)
  return token.replace(/(moneda|cotizacion|cotiz|tasa|venta|imad)/ig,'').trim();
}

/* ---------- CSV processing ---------- */
function processRows(rows){
  rates = {}; countries = new Set(); rawPairs = [];
  // iterate rows and attempt to detect D cell with pair
  for(let i=0;i<rows.length;i++){
    const row = rows[i];
    const rawD = row[3] ? String(row[3]).trim() : '';
    if(!rawD) continue;
    // Look if this cell looks like a "pair" (contains dash or ' a ' or ' to ' or '/')
    const likelyPair = /[-–—\/\\]|(\s+a\s)|(\s+to\s)/i.test(rawD);
    if(!likelyPair){
      // It might still be a pair but with label like "Cotización Mesa - ...", try to clean and test
      const cleaned = String(rawD).replace(/Cotizaci[oó]n Mesa/ig,'').trim();
      if(!/[-–—\/\\]|(\s+a\s)|(\s+to\s)/i.test(cleaned)) continue; // not a pair
    }
    // Try to split
    const parts = splitPair(rawD);
    if(!parts || parts.length < 2) {
      // Push raw for debug and skip
      rawPairs.push({row:i+1, raw: rawD});
      continue;
    }
    let [leftRaw, rightRaw] = parts;
    // canonicalize tokens (map codes to names if possible)
    const left = canonicalizeCountry(leftRaw);
    const right = canonicalizeCountry(rightRaw);
    // find nearby price (prefer next row)
    const found = findNearbyPrice(rows, i);
    if(!found) {
      // if price not found, skip but record raw for debug
      rawPairs.push({row:i+1, raw: rawD});
      continue;
    }
    const price = found.price;
    // store nested
    if(!rates[left]) rates[left] = {};
    rates[left][right] = price;
    countries.add(left); countries.add(right);
  }
  // fallback: if nothing found, try alternative strategy:
  if(Object.keys(rates).length === 0){
    // Try to look for pattern where D is empty but pair header exists at certain intervals
    // (This fallback is conservative: if nothing found, create sample rates so UI isn't empty)
    rates = { 'Chile': { 'Venezuela': 0.2371, 'USA': 852.75 }, 'Argentina': {'Chile':0.1483} };
    ['Chile','Venezuela','USA','Argentina'].forEach(c=>countries.add(c));
    console.warn('No rates auto-detected; using fallback demo rates.');
  }
  populateUI();
}

/* ---------- UI population ---------- */
function populateUI(){
  const selO = document.getElementById('selOrigen');
  const selD = document.getElementById('selDestino');
  // clear
  selO.innerHTML = '<option value="">Selecciona origen...</option>';
  selD.innerHTML = '<option value="">Selecciona destino...</option>';
  const list = Array.from(countries).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
  list.forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
    selO.appendChild(opt);
    selD.appendChild(opt.cloneNode(true));
  });
  renderRatesTable();
}

/* render rates table */
function renderRatesTable(){
  const tbody = document.querySelector('#ratesTable tbody');
  tbody.innerHTML = '';
  const rows = [];
  Object.keys(rates).forEach(from => {
    Object.keys(rates[from]).forEach(to => {
      rows.push({from,to,price:rates[from][to]});
    });
  });
  if(rows.length === 0){
    tbody.innerHTML = '<tr><td colspan="3" style="color:var(--muted);padding:16px">No hay tasas detectadas</td></tr>';
    return;
  }
  rows.sort((a,b)=>a.from.localeCompare(b.from) || a.to.localeCompare(b.to));
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = r.from;
    const td2 = document.createElement('td'); td2.textContent = r.to;
    const td3 = document.createElement('td'); td3.style.textAlign='right'; td3.textContent = Number(r.price).toLocaleString(undefined,{minimumFractionDigits:4,maximumFractionDigits:4});
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tbody.appendChild(tr);
  });
}

/* find rate: exact then tolerant */
function lookupRate(orig, dest){
  if(!orig || !dest) return null;
  if(rates[orig] && rates[orig][dest] !== undefined) return {price: rates[orig][dest], key:`${orig}-${dest}`, reversed:false};
  // tolerant: normalized match
  const norm = s => normalizeKey(s);
  const targetFrom = norm(orig), targetTo = norm(dest);
  // exact normalized
  for(const f of Object.keys(rates)){
    for(const t of Object.keys(rates[f])){
      if(norm(f) === targetFrom && norm(t) === targetTo) return {price:rates[f][t], key:`${f}-${t}`, reversed:false};
    }
  }
  // partial contains (handles 'clp' vs 'chile')
  for(const f of Object.keys(rates)){
    for(const t of Object.keys(rates[f])){
      if(norm(f).includes(targetFrom) && norm(t).includes(targetTo)) return {price:rates[f][t], key:`${f}-${t}`, reversed:false};
      if(targetFrom.includes(norm(f)) && targetTo.includes(norm(t))) return {price:rates[f][t], key:`${f}-${t}`, reversed:false};
    }
  }
  // try reverse detection
  for(const f of Object.keys(rates)){
    for(const t of Object.keys(rates[f])){
      if(norm(f) === targetTo && norm(t) === targetFrom){
        return {price:rates[f][t], key:`${f}-${t}`, reversed:true};
      }
    }
  }
  return null;
}

/* ---------- Events: calc, copy, telegram ---------- */
document.getElementById('btnCalc').addEventListener('click', ()=> {
  const orig = document.getElementById('selOrigen').value;
  const dest = document.getElementById('selDestino').value;
  const montoRaw = document.getElementById('monto').value;
  const hudL = document.getElementById('hudLeft');
  const hudR = document.getElementById('hudRight');
  if(!orig || !dest || !montoRaw || Number(montoRaw) <= 0){
    hudL.innerHTML = '<span style="color:#ff8a8a">Completa origen, destino y monto válido</span>'; hudR.innerText='--'; return;
  }
  if(orig === dest){ hudL.innerHTML = '<span style="color:#ff8a8a">Origen y destino deben ser distintos</span>'; hudR.innerText='--'; return; }
  const lookup = lookupRate(orig,dest);
  if(!lookup){ hudL.innerHTML = '<span style="color:#ff8a8a">Ruta no disponible (no se encuentra tasa)</span>'; hudR.innerText='--'; return; }
  if(lookup.reversed){ hudL.innerHTML = `<span style="color:#ffb86b">Atención: tasa encontrada en sentido inverso (${lookup.key}). Verifica.</span>`; hudR.innerText='--'; return; }
  const monto = Number(montoRaw);
  const recibe = monto * Number(lookup.price);
  // animate count-up (smooth)
  animateCountUp(0, recibe, 700, v => { hudR.innerText = Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); });
  hudL.innerHTML = `${Number(monto).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} (${orig}) → recibe:`;
  // small stored info for telegram / copy
  window._last = {orig,dest,monto,recibe,rate:lookup.price};
});

document.getElementById('btnCopy').addEventListener('click', ()=>{
  const last = window._last;
  if(!last){ alert('No hay resultado para copiar. Haz un cálculo primero.'); return; }
  const text = `Enviar ${last.monto} ${last.orig} → Recibir ${Number(last.recibe).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} ${last.dest} (Tasa: ${last.rate})`;
  navigator.clipboard?.writeText(text).then(()=>alert('Resultado copiado al portapapeles'), ()=>alert('No se pudo copiar'));
});

document.getElementById('btnTelegram').addEventListener('click', ()=>{
  const last = window._last;
  const selO = document.getElementById('selOrigen').value;
  const selD = document.getElementById('selDestino').value;
  const monto = document.getElementById('monto').value;
  if(!selO || !selD || !monto){ alert('Completa origen, destino y monto antes de pedir el servicio.'); return; }
  let recibeTxt = '';
  if(last && last.orig === selO && last.dest === selD && Number(last.monto) === Number(monto)) recibeTxt = Number(last.recibe).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  else {
    const lookup = lookupRate(selO,selD);
    if(!lookup || lookup.reversed){ alert('No hay tasa detectada para esa ruta'); return; }
    recibeTxt = Number(Number(monto) * lookup.price).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  }
  const msg = `Hola, quiero enviar ${Number(monto).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} (${selO}) y que reciban ${recibeTxt} (${selD}). Tasa (Venta IMAD) aplicada.`;
  const href = TELEGRAM_LINK + (TELEGRAM_LINK.includes('?') ? '&' : '?') + 'text=' + encodeURIComponent(msg);
  window.open(href,'_blank');
});

/* ---------- CSV loading ---------- */
async function loadCSV(){
  try{
    const r = await fetch(CSV_URL);
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const txt = await r.text();
    Papa.parse(txt, {
      header:false,
      skipEmptyLines:true,
      complete: results => processRows(results.data)
    });
  } catch(e){
    console.error('Error leyendo CSV', e);
    // fallback sample so UI isn't empty
    rates = { 'Chile': {'Venezuela':0.2371, 'USA':852.75}, 'Argentina': {'Chile':0.1483} };
    ['Chile','Venezuela','USA','Argentina'].forEach(c=>countries.add(c));
    populateUI();
    alert('No se pudo leer sheet. Verifica que CSV público esté activo. Se cargaron tasas de ejemplo.');
  }
}

/* ---------- small count up ---------- */
function animateCountUp(from, to, ms, onFrame){
  const start = performance.now();
  function frame(now){
    const t = Math.min(1,(now-start)/ms);
    const ease = 1 - Math.pow(1-t,3); // easeOutCubic
    const cur = from + (to-from)*ease;
    onFrame(cur);
    if(t < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

/* ---------- BG: radar & particles ---------- */
(function bgAnim(){
  const cvs = document.getElementById('bg');
  if(!cvs) return;
  const ctx = cvs.getContext('2d');
  let W = cvs.width = window.innerWidth * devicePixelRatio;
  let H = cvs.height = window.innerHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  let parts = [];
  for(let i=0;i<90;i++) parts.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+0.6,dx:(Math.random()-0.5)*0.4,dy:(Math.random()-0.5)*0.4});
  let t = 0;
  function resize(){ W = cvs.width = window.innerWidth * devicePixelRatio; H = cvs.height = window.innerHeight * devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
  window.addEventListener('resize', resize);
  function draw(){
    ctx.clearRect(0,0,W,H);
    // subtle gradient
    const g = ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,'rgba(0,0,0,0.2)'); g.addColorStop(1,'rgba(0,0,0,0.05)'); ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    // rings
    const cx = W*0.18, cy = H*0.18;
    for(let i=0;i<5;i++){
      ctx.beginPath(); ctx.arc(cx,cy,50+i*60 + (t%60),0,Math.PI*2); ctx.strokeStyle = `rgba(0,180,255,${0.02 + i*0.01})`; ctx.lineWidth = 1; ctx.stroke();
    }
    // sweep
    ctx.beginPath();
    const ang = (t/40)%360 * Math.PI/180;
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,300, ang-0.25, ang+0.25);
    ctx.closePath();
    ctx.fillStyle = 'rgba(0,180,255,0.02)'; ctx.fill();
    // particles
    parts.forEach((p,idx)=>{
      ctx.beginPath(); ctx.fillStyle = 'rgba(0,180,255,0.6)'; ctx.arc(p.x/p.devicePixelRatio||p.x,p.y/p.devicePixelRatio||p.y,p.r,0,Math.PI*2); ctx.fill();
      p.x += p.dx; p.y += p.dy;
      if(p.x > W) p.x = 0; if(p.x < 0) p.x = W;
      if(p.y > H) p.y = 0; if(p.y < 0) p.y = H;
    });
    t+=0.9;
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

/* ---------- Init ---------- */
loadCSV();
</script>
</body>
</html>
