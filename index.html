<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackbird Exchange — Concierge</title>
  <style>
    /* Tema amigable con vibe SR-71: Oscuro pero suave, con toques verdes y negros, pero no tan intenso */
    body {
      font-family: Arial, sans-serif; /* Fuente amigable y legible */
      background-color: #1a1a1a; /* Gris oscuro suave en lugar de negro puro */
      color: #ffffff; /* Blanco para contraste */
      max-width: 100vw;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    h1, h2, h3 { color: #00ff00; text-shadow: 0 0 3px #00ff00; } /* Verde suave con glow sutil */
    select, input, button {
      background-color: #333333;
      color: #ffffff;
      border: 1px solid #00ff00;
      padding: 10px;
      margin: 10px 0;
      font-family: inherit;
      border-radius: 5px; /* Bordes redondeados para amigabilidad */
    }
    button:hover { background-color: #444444; cursor: pointer; }
    .result { font-weight: bold; font-size: 1.2em; color: #00ff00; }
    table {
      border-collapse: collapse;
      width: 100%;
      background-color: #333333;
      border: 1px solid #00ff00;
    }
    th, td {
      border: 1px solid #00ff00;
      padding: 10px;
      text-align: left;
      color: #ffffff;
    }
    th { background-color: #222222; }
    button.invert { background: none; border: none; color: #ff0000; font-size: 1.2em; cursor: pointer; }
    footer {
      margin-top: 20px;
      text-align: center;
      font-size: 0.9em;
      color: #cccccc;
    }
    footer a { color: #00ff00; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    .loader { display: none; color: #00ff00; font-size: 1em; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    .container { 
      border: 2px solid #00ff00; 
      padding: 20px; 
      box-shadow: 0 0 5px #00ff00; 
      background: rgba(0, 0, 0, 0.7); 
      border-radius: 10px; /* Amigable */
    }
    label { display: block; color: #cccccc; }
    img.logo { max-width: 200px; display: block; margin: 0 auto 20px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo%20blackbird.png" alt="Logo Blackbird" class="logo">
    <h1>Blackbird Exchange — Concierge</h1>
    <h2>Interfaz premium — Cabina SR-71</h2>
    
    <div>
      <h3>Exchange · Cliente</h3>
      <p>Frontend · lectura directa</p>
      
      <label>Origen</label>
      <select id="origin" onchange="updateRates()">
        <option value="">Cargando países...</option>
      </select>
      
      <label>Destino</label>
      <select id="destination" onchange="updateRates()">
        <option value="">Selecciona destino...</option>
      </select>
      
      <label>Monto (moneda local)</label>
      <input type="number" id="amount" placeholder="Ingresa monto" oninput="validateAmount()">
      
      <button onclick="calculate()">Calcular</button>
      <button onclick="copyResult()">Copiar</button>
      <a href="https://t.me/BlackbirdExchange" target="_blank"><button>Pedir por Telegram</button></a>
      
      <p class="result" id="result">Resultado aparecerá aquí</p>
      <p class="loader" id="loader">Cargando tasas desde tu sheet...</p>
    </div>
    
    <div>
      <p>Si un par sale raro, abre la tabla de tasas y usa el icono "invertir" para forzar la lógica. El sistema intenta detectar automáticamente si debe multiplicar o dividir.</p>
      <h3>Tasas detectadas</h3>
      <table id="ratesTable">
        <thead>
          <tr><th>Origen</th><th>Destino</th><th>Tasa</th><th>Acción</th><th>Panel de diagnóstico</th></tr>
        </thead>
        <tbody id="ratesBody"></tbody>
      </table>
    </div>
  </div>
  
  <footer>
    © 2025 Blackbird Exchange — Concierge<br>
    Contacto: <a href="https://t.me/+i02VPMg23TNiOWJh">Canal de Telegram</a> | <a href="https://www.instagram.com/servicios_blackbird?igsh=MTlwZTVsaWR4dDBoMQ%3D%3D&utm_source=qr">Instagram</a> | <a href="https://www.tiktok.com/@remesasblackbird?_t=ZM-8zqW0ByBXVg&_r=1">TikTok</a>
  </footer>
  
  <script>
    // Mapeo de abreviaturas de países a nombres completos y monedas (amplíalo si es necesario)
    const abbrToCountry = {
      "ARG": {name: "Argentina", currency: "ARS"},
      "USA": {name: "Estados Unidos", currency: "USD"},
      "BRA": {name: "Brasil", currency: "BRL"},
      "CHL": {name: "Chile", currency: "CLP"},
      "COL": {name: "Colombia", currency: "COP"},
      "MEX": {name: "México", currency: "MXN"},
      "EUR": {name: "Eurozona", currency: "EUR"},
      "GBR": {name: "Reino Unido", currency: "GBP"},
      "JPN": {name: "Japón", currency: "JPY"},
      "CAN": {name: "Canadá", currency: "CAD"},
      "AUS": {name: "Australia", currency: "AUD"},
      "VEN": {name: "Venezuela", currency: "VES"},
      "PER": {name: "Perú", currency: "PEN"},
      "URY": {name: "Uruguay", currency: "UYU"},
      "PRY": {name: "Paraguay", currency: "PYG"},
      // Agrega más abreviaturas basadas en tu sheet
    };

    let ratesData = []; // Almacena datos de países, pares y tasas

    // Cargar datos del CSV
    async function loadSheetData() {
      const loader = document.getElementById('loader');
      loader.style.display = 'block';
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vT9Teo-_5ka3LKx7FXL3x3yV3uf4KhoI61ewnVJyJ90XRnksoObf4CDn-lJvrFKiQ/pub?gid=983978085&single=true&output=csv');
        if (!response.ok) throw new Error('Error al cargar el sheet');
        const csvText = await response.text();
        const rows = csvText.split('\n').map(row => row.split(','));
        
        // Extraer según el patrón: países en B4 (index 3[1]), B13 (12[1]), B22 (21[1])...
        // Pares en D6 (5[3]), D15 (14[3]), D24 (23[3])...
        // Tasas en F7 (6[5]), F16 (15[5]), F25 (24[5])... (usando columna F=5 como en tu último mensaje; si alterna, ajusta)
        for (let n = 0; ; n++) {
          const countryRow = 3 + n * 9; // 3,12,21,... (0-based for B4, B13...)
          const countryAbbr = rows[countryRow]?.[1]?.trim() || '';
          if (!countryAbbr) break; // Detener si no hay más
          
          const pairRow = 5 + n * 9; // 5,14,23,...
          const pairCell = rows[pairRow]?.[3]?.trim() || '';
          const pairParts = pairCell.split('/').map(p => p.trim());
          const originCurr = pairParts[0] || '';
          const destCurr = pairParts[1] || '';
          
          const rateRow = 6 + n * 9; // 6,15,24,...
          let rateStr = rows[rateRow]?.[5] || ''; // Columna F=5 primero
          if (!rateStr.trim()) rateStr = rows[rateRow]?.[6] || ''; // Si vacío, probar G=6
          const rate = parseFloat(rateStr.replace(',', '.')) || 0;
          
          const countryInfo = abbrToCountry[countryAbbr] || {name: countryAbbr, currency: originCurr}; // Fallback si no en mapeo
          
          ratesData.push({
            countryAbbr,
            countryName: countryInfo.name,
            originCurr,
            destCurr,
            rate,
            inverted: false,
            cell: `Fila ${rateRow + 1}, Celda ${rateStr === rows[rateRow]?.[5] ? 'F' : 'G'}`
          });
        }
        
        // Poblar selectores con países origen y destino (asumiendo destinos de los pares)
        const originSelect = document.getElementById('origin');
        const destinationSelect = document.getElementById('destination');
        originSelect.innerHTML = '<option value="">Selecciona origen...</option>';
        destinationSelect.innerHTML = '<option value="">Selecciona destino...</option>';
        
        const uniqueDestCurr = new Set(ratesData.map(d => d.destCurr));
        ratesData.forEach(data => {
          originSelect.innerHTML += `<option value="${data.countryAbbr}">${data.countryName} (${data.originCurr})</option>`;
        });
        
        // Para destinos, usar el mapeo inverso: curr to country
        const currToCountry = {};
        Object.entries(abbrToCountry).forEach(([abbr, info]) => {
          currToCountry[info.currency] = info.name;
        });
        uniqueDestCurr.forEach(curr => {
          const countryName = currToCountry[curr] || curr; // Fallback
          destinationSelect.innerHTML += `<option value="${curr}">${countryName} (${curr})</option>`;
        });
        
        updateRates();
      } catch (error) {
        document.getElementById('result').textContent = 'Error al cargar datos: ' + error.message;
      } finally {
        loader.style.display = 'none';
      }
    }

    // Actualizar tabla
    function updateRates() {
      const tbody = document.getElementById('ratesBody');
      tbody.innerHTML = '';
      ratesData.forEach((data, index) => {
        const effectiveRate = data.inverted ? (1 / data.rate) : data.rate;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.originCurr}</td>
          <td>${data.destCurr}</td>
          <td>${effectiveRate.toFixed(4)}</td>
          <td><button class="invert" onclick="invertRate(${index})">↺</button></td>
          <td>${data.cell} (para ${data.countryName})</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Invertir
    function invertRate(index) {
      ratesData[index].inverted = !ratesData[index].inverted;
      updateRates();
    }

    // Validar monto
    function validateAmount() {
      const amountInput = document.getElementById('amount');
      if (amountInput.value < 0) amountInput.value = 0;
    }

    // Calcular
    function calculate() {
      const originAbbr = document.getElementById('origin').value;
      const destCurr = document.getElementById('destination').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const resultDiv = document.getElementById('result');
      
      if (!originAbbr || !destCurr || isNaN(amount) || amount <= 0) {
        resultDiv.textContent = 'Completa los campos correctamente.';
        return;
      }
      
      const pair = ratesData.find(d => d.countryAbbr === originAbbr && d.destCurr === destCurr);
      
      if (!pair) {
        resultDiv.textContent = 'Par no disponible para este origen y destino.';
        return;
      }
      
      let effectiveRate = pair.rate;
      if (!pair.inverted) {
        // Detección auto: si rate >1, multiplicar; <1, dividir (ajusta según lógica)
        if (effectiveRate < 1) effectiveRate = 1 / effectiveRate;
      } else {
        effectiveRate = pair.inverted ? (1 / pair.rate) : pair.rate;
      }
      
      const result = amount * effectiveRate; // Asumir multiplicar; ajusta si es divide
      const destCountry = document.getElementById('destination').options[document.getElementById('destination').selectedIndex].text.split(' (')[0];
      
      resultDiv.textContent = `${result.toFixed(2)} ${destCurr} (moneda oficial de ${destCountry})`;
    }

    // Copiar
    function copyResult() {
      const resultText = document.getElementById('result').textContent;
      navigator.clipboard.writeText(resultText).then(() => alert('Copiado')).catch(err => alert('Error: ' + err));
    }

    // Iniciar
    window.onload = loadSheetData;
  </script>
</body>
</html>
