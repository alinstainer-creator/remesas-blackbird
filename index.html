<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Blackbird SR-71 ‚Äî Calculadora Ultrapremium (Venta IMAD)</title>
<meta name="description" content="Calculadora Blackbird SR-71 - Lee CSV de Google Sheets, usa filas 'Venta IMAD' y precios en F/G.">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000000;
  --panel:#07070a;
  --accent:#00d0ff;
  --accent-deep:#0077cc;
  --muted:#9fbfdc;
  --glass: rgba(255,255,255,0.025);
  --success:#4de07a;
  --danger:#ff6f6f;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#000 0%,#05050a 60%);color:#e9fbff;font-family:'Roboto Condensed',sans-serif}
.page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
.shell{width:100%;max-width:1200px;border-radius:16px;position:relative;overflow:hidden;border:1px solid rgba(0,208,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.85)}
canvas#radarBG{position:absolute;inset:0;width:100%;height:100%;z-index:0;opacity:0.12;filter:blur(0.6px)}
.header{position:relative;z-index:2;padding:22px 28px;display:flex;gap:18px;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.logo{width:92px;height:92px;border-radius:50%;border:3px solid var(--accent);box-shadow:0 12px 40px rgba(0,208,255,0.06);object-fit:cover}
.brand{flex:1}
.title{font-family:'Orbitron',monospace;color:var(--accent);font-size:20px;margin:0}
.subtitle{color:var(--muted);font-size:13px;margin-top:6px}
.body{display:grid;grid-template-columns:1fr 420px;gap:20px;padding:24px;position:relative;z-index:2}
@media(max-width:980px){ .body{grid-template-columns:1fr} }
.card{background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.02)}
label{display:block;font-size:12px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;font-weight:700}
.row{display:flex;gap:12px}
.col{flex:1}
select,input{width:100%;padding:12px 14px;border-radius:10px;background:rgba(10,10,12,0.6);border:1px solid rgba(255,255,255,0.03);color:#eafcff;font-size:15px}
select:focus,input:focus{outline:none;box-shadow:0 8px 26px rgba(0,208,255,0.06);border-color:var(--accent)}
.small{font-size:13px;color:var(--muted);margin-top:8px}
.actions{display:flex;gap:12px;margin-top:14px}
.btn{flex:1;padding:12px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:800;letter-spacing:0.6px}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-deep));color:#02131a;box-shadow:0 10px 30px rgba(0,208,255,0.12), inset 0 1px 0 rgba(255,255,255,0.06)}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
.btn-telegram{background:linear-gradient(90deg,#2bd36b,#1ea64b);color:#02110a}
.btn:hover{transform:translateY(-3px);box-shadow:0 22px 60px rgba(0,208,255,0.08)}
.result{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(0,180,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(0,180,255,0.04)}
.res-left{font-size:14px;color:#eafcff}
.res-right{font-family:'Orbitron',monospace;color:var(--accent);font-size:22px}
.side-title{font-family:'Orbitron',monospace;color:var(--accent);font-size:15px;margin-bottom:10px}
.table-wrap{max-height:520px;overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse;color:#eafcff}
th,td{padding:10px 8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
th{background:linear-gradient(90deg,var(--accent),var(--accent-deep));color:#02131a;font-weight:800;font-size:12px}
.td-right{text-align:right}
.footer{display:flex;justify-content:space-between;align-items:center;padding:14px 22px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-top:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
.note{font-size:12px;color:var(--muted);margin-top:10px}
@media(max-width:520px){ .header{padding:16px} .body{padding:16px} .res-right{font-size:18px} }
</style>
</head>
<body>
<div class="page">
  <div class="shell">
    <canvas id="radarBG"></canvas>

    <div class="header">
      <img src="logo blackbird.png" alt="logo" class="logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/92/00d0ff/071017?text=SR-71'">
      <div class="brand">
        <div class="title">BLACKBIRD SR-71 ‚Äî REMESAS</div>
        <div class="subtitle">Ultrapremium ‚Ä¢ Lectura fiable desde tu Google Sheet</div>
      </div>
      <div style="text-align:right;color:var(--muted);font-size:12px">vFINAL ‚Ä¢ LAB-GRADE</div>
    </div>

    <div class="body">
      <!-- LEFT -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>
            <div style="font-weight:800;color:var(--accent);font-size:13px">Calculadora Blackbird</div>
            <div class="note">Selecciona origen y destino (los pa√≠ses salen desde la columna D de tu sheet). Presiona CALCULAR.</div>
          </div>
          <div style="font-size:12px;color:var(--muted)">Modo: frontend directo</div>
        </div>

        <div style="margin-top:8px">
          <label for="selOrigen">Pa√≠s de Origen</label>
          <select id="selOrigen"><option value="">Cargando pa√≠ses...</option></select>
        </div>

        <div style="margin-top:12px">
          <label for="selDestino">Pa√≠s de Destino</label>
          <select id="selDestino"><option value="">Cargando pa√≠ses...</option></select>
        </div>

        <div style="margin-top:12px">
          <label for="monto">Monto (moneda local del origen)</label>
          <input id="monto" type="number" placeholder="Ej. 1000.00" />
        </div>

        <div class="actions">
          <button id="btnCalcular" class="btn btn-primary">CALCULAR</button>
          <button id="btnPedido" class="btn btn-telegram">PEDIR POR TELEGRAM</button>
        </div>

        <div id="resultado" class="result">
          <div class="res-left">Aqu√≠ ver√°s cu√°nto recibir√° el destinatario</div>
          <div class="res-right">--</div>
        </div>

        <div class="note">Aseg√∫rate de que tu sheet est√© publicado en la web (o en modo lectura). Si quieres, p√©game 5 filas de ejemplo y ajusto el parser en caliente.</div>
      </div>

      <!-- RIGHT -->
      <aside class="card">
        <div class="side-title">Tasas (Venta IMAD)</div>
        <div class="table-wrap">
          <table id="ratesTable">
            <thead><tr><th>Origen</th><th>Destino</th><th class="td-right">Tasa</th></tr></thead>
            <tbody><tr><td colspan="3" style="color:var(--muted);padding:18px">Cargando tasas...</td></tr></tbody>
          </table>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div class="note">Contacto y redes</div>
          <div style="display:flex;gap:8px"><a href="https://t.me/+i02VPMg23TNiOWJh" target="_blank">‚úàÔ∏è</a><a href="https://www.instagram.com/servicios_blackbird" target="_blank">üì∏</a><a href="https://www.tiktok.com/@remesasblackbird" target="_blank">üéµ</a></div>
        </div>
      </aside>
    </div>

    <div class="footer">
      <div>¬© 2025 Blackbird SR-71 ‚Äî Ultrapremium</div>
      <div style="color:var(--muted);font-size:12px">Optimizado para m√≥viles ‚Ä¢ Experiencia Mach-3</div>
    </div>
  </div>
</div>

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
/* ========== CONFIG ========== */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3yMHp1HF-2JS1j0vNcp_snCjtTaWuF6y8AldyFGxbWvQrmhvisnagcBC1pWiskalafvz0EVY8svR6/pub?gid=983978085&single=true&output=csv';
const TELEGRAM_LINK = 'https://t.me/+i02VPMg23TNiOWJh';
const RATE_MARKER = 'Venta IMAD'; // text in column J that signals the desired row
/* ============================ */

let rates = {};   // { "from|||to": price }
let countriesSet = new Set();
let allPairsSeen = []; // array of raw pair strings (for debugging)

/* utility: remove accents and normalize string */
function normalizeStr(s){
  if(!s) return '';
  // strip html / weird whitespace
  s = String(s).trim();
  // remove diacritics
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  // lower case
  s = s.toLowerCase();
  // remove extra symbols from ends
  s = s.replace(/^[^a-z0-9]+|[^a-z0-9]+$/gi,'');
  // collapse spaces
  s = s.replace(/\s+/g,' ');
  return s;
}

/* parse price robustly: accepts "$852.75", "852,75", "0.2371", "0,2371" */
function parsePrice(raw){
  if(raw === undefined || raw === null) return NaN;
  let s = String(raw).trim();
  if(s === '') return NaN;
  // strip currency symbols except digits, commas, dots, minus
  s = s.replace(/[^\d\.,\-]/g,'').trim();
  // if both comma and dot present, treat comma as thousand separator -> remove commas
  if(s.indexOf(',') !== -1 && s.indexOf('.') !== -1){
    s = s.replace(/,/g,'');
  } else if(s.indexOf(',') !== -1 && s.indexOf('.') === -1){
    // only comma present -> assume decimal separator
    s = s.replace(/,/g,'.');
  }
  // remove stray non numeric
  s = s.replace(/^[^0-9\-]+|[^0-9]+$/g,'');
  const n = parseFloat(s);
  return isNaN(n) ? NaN : n;
}

/* split pair into [from,to] for many separators */
function splitPair(rawPair){
  if(!rawPair) return null;
  let p = String(rawPair).trim();
  // normalize multiple whitespace
  p = p.replace(/\s+/g,' ');
  // try splitting by " - " or " -", "-", " ‚Äì ", "‚Äî", " a ", " to ", "/", "\"
  const parts = p.split(/\s*(?:[-‚Äì‚Äî\/\\]|(?:\sa\s)|(?:\sto\s))\s*/i).map(x=>x.trim()).filter(Boolean);
  if(parts.length >= 2) return [parts[0], parts[1]];
  // fallback: split by space if exactly 2 tokens
  const tokens = p.split(' ').filter(Boolean);
  if(tokens.length === 2) return [tokens[0], tokens[1]];
  return null;
}

/* load CSV and process */
async function loadAndProcess(){
  try{
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error('CSV fetch failed ' + res.status);
    const text = await res.text();
    Papa.parse(text, {header:false, skipEmptyLines:true, complete: (r) => handleRows(r.data) });
  }catch(e){
    console.error('Error loading CSV:', e);
    // fallback demo
    rates = {'Chile|||Venezuela': 0.2371, 'Chile|||USA':852.75, 'Argentina|||Chile': 0.005};
    countriesSet = new Set(['Chile','Venezuela','USA','Argentina']);
    populateSelects();
    renderRatesTable();
    console.warn('Usando fallback demo rates');
  }
}

/* handle rows: build country list from col D and rates from rows where col J == RATE_MARKER using F or G */
function handleRows(rows){
  rates = {};
  countriesSet = new Set();
  allPairsSeen = [];
  // first gather all pairs seen in column D so selects include all possible countries
  rows.forEach((row, idx)=>{
    const rawPair = row[3] ? String(row[3]).trim() : '';
    if(rawPair){
      allPairsSeen.push(rawPair);
      const parsed = splitPair(rawPair);
      if(parsed && parsed.length >= 2){
        countriesSet.add(parsed[0]);
        countriesSet.add(parsed[1]);
      }
    }
  });

  // second, find rows where column J equals RATE_MARKER and use price from F or G
  rows.forEach((row, idx)=>{
    const marker = row[9] ? String(row[9]).trim() : '';
    if(marker && marker.toLowerCase() === RATE_MARKER.toLowerCase()){
      const rawPair = row[3] ? String(row[3]).trim() : '';
      const parsed = splitPair(rawPair);
      if(parsed && parsed.length >= 2){
        const pF = parsePrice(row[5]);
        const pG = parsePrice(row[6]);
        const price = (!isNaN(pF) && pF !== 0) ? pF : ((!isNaN(pG) && pG !== 0) ? pG : NaN);
        if(!isNaN(price)){
          const key = `${parsed[0]}|||${parsed[1]}`;
          rates[key] = price;
        }
      }
    }
  });

  // If no countries found via pairs, try scanning column D raw for tokens to synthesize list
  if(countriesSet.size === 0 && allPairsSeen.length > 0){
    allPairsSeen.forEach(raw => {
      const parsed = splitPair(raw);
      if(parsed && parsed.length >= 2){
        countriesSet.add(parsed[0]); countriesSet.add(parsed[1]);
      }
    });
  }

  // If still empty -> fallback sample
  if(countriesSet.size === 0){
    countriesSet = new Set(['Chile','Venezuela','USA','Mexico','Argentina','Peru','Colombia','Ecuador','Spain','Canada','Uruguay','Brazil']);
    console.warn('No pairs detected ‚Äî usando fallback country list');
  }

  populateSelects();
  renderRatesTable();
}

/* helper: produce normalized matching key */
function normForMatch(s){
  // normalize and also remove common words
  const n = normalizeStr(s);
  return n.replace(/\b(country|rep√∫blica|de|del|the)\b/g,'').trim();
}

/* attempt to find rate given origin,dest with tolerant matching */
function findRateFor(origin, dest){
  if(!origin || !dest) return undefined;
  const candidates = Object.keys(rates);
  const targetFrom = normForMatch(origin);
  const targetTo = normForMatch(dest);

  // direct exact normalized match
  for(const k of candidates){
    const [f,t] = k.split('|||');
    if(normForMatch(f) === targetFrom && normForMatch(t) === targetTo) return {key:k, price:rates[k]};
  }

  // try case-insensitive trimmed direct (original strings)
  for(const k of candidates){
    const [f,t] = k.split('|||');
    if(String(f).trim().toLowerCase() === String(origin).trim().toLowerCase()
       && String(t).trim().toLowerCase() === String(dest).trim().toLowerCase()) return {key:k, price:rates[k]};
  }

  // fuzzy: check if targetFrom exists inside normalized f or viceversa (handles 'Chile, CL' vs 'Chile')
  for(const k of candidates){
    const [f,t] = k.split('|||');
    const nf = normForMatch(f);
    const nt = normForMatch(t);
    if(nf.includes(targetFrom) && nt.includes(targetTo)) return {key:k, price:rates[k]};
    if(targetFrom.includes(nf) && targetTo.includes(nt)) return {key:k, price:rates[k]};
  }

  // try reverse match? (maybe sheet stored dest->origin but user picks origin->dest)
  for(const k of candidates){
    const [f,t] = k.split('|||');
    if(normForMatch(f) === targetTo && normForMatch(t) === targetFrom){
      // found reverse direction; but this rate is for reverse; we inform user
      return {key:k, price:rates[k], reversed:true};
    }
  }

  return undefined;
}

/* populate country selects */
function populateSelects(){
  const selO = document.getElementById('selOrigen');
  const selD = document.getElementById('selDestino');
  selO.innerHTML = '<option value="">Selecciona pa√≠s...</option>';
  selD.innerHTML = '<option value="">Selecciona pa√≠s...</option>';
  const arr = Array.from(countriesSet).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
  arr.forEach(c=>{
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
    selO.appendChild(opt);
    selD.appendChild(opt.cloneNode(true));
  });
}

/* render rates table */
function renderRatesTable(){
  const tbody = document.querySelector('#ratesTable tbody');
  tbody.innerHTML = '';
  const keys = Object.keys(rates).sort((a,b)=>a.localeCompare(b));
  if(keys.length === 0){
    tbody.innerHTML = '<tr><td colspan="3" style="color:var(--muted);padding:14px">No se encontraron tasas "Venta IMAD" (columna J)</td></tr>';
    return;
  }
  keys.forEach(k=>{
    const [f,t] = k.split('|||');
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = f;
    const td2 = document.createElement('td'); td2.textContent = t;
    const td3 = document.createElement('td'); td3.className='td-right'; td3.textContent = formatNumber(rates[k]);
    tr.append(td1,td2,td3); tbody.appendChild(tr);
  });
}

/* format number */
function formatNumber(n){
  if(isNaN(n)) return '--';
  return Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}

/* calculate on button press */
function onCalculate(){
  const origen = document.getElementById('selOrigen').value;
  const destino = document.getElementById('selDestino').value;
  const montoRaw = document.getElementById('monto').value;
  const left = document.querySelector('.res-left');
  const right = document.querySelector('.res-right');

  if(!origen || !destino){
    left.innerHTML = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#ff6f6f'}">Selecciona origen y destino</span>`;
    right.innerText = '--';
    return;
  }
  if(origen === destino){
    left.innerHTML = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#ff6f6f'}">Origen y destino deben ser distintos</span>`;
    right.innerText='--';
    return;
  }
  const monto = Number(montoRaw);
  if(isNaN(monto) || monto <= 0){
    left.innerHTML = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#ff6f6f'}">Ingresa monto v√°lido (>0)</span>`;
    right.innerText='--';
    return;
  }

  const match = findRateFor(origen, destino);
  if(!match){
    left.innerHTML = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#ff6f6f'}">Ruta no disponible (no se encuentra tasa)</span>`;
    right.innerText='--';
    return;
  }
  if(match.reversed){
    left.innerHTML = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#ff6f6f'}">Atenci√≥n: la hoja tiene la ruta inversa (${match.key.replace('|||',' ‚Üí ')}). Verifica.</span>`;
    right.innerText='--';
    return;
  }

  const recibe = monto * match.price;
  // animate count-up
  animateCountUp(0, recibe, 800, v => {
    right.innerText = formatNumber(v);
  });
  left.innerHTML = `${Number(monto).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} (${origen}) ‚Üí recibe:`;
  window._lastCalc = {origen,destino,monto,recibe,price:match.price};
  // subtle pulse
  const box = document.getElementById('resultado');
  box.classList.add('pulse');
  setTimeout(()=>box.classList.remove('pulse'),900);
}

/* count up */
function animateCountUp(from, to, ms, onFrame){
  const start = performance.now();
  function frame(now){
    const t = Math.min(1, (now - start)/ms);
    const ease = 1 - Math.pow(1 - t, 3); // easeOutCubic
    const curr = from + (to - from) * ease;
    onFrame(curr);
    if(t < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

/* pedir por telegram */
function onPedido(){
  const origen = document.getElementById('selOrigen').value;
  const destino = document.getElementById('selDestino').value;
  const montoRaw = document.getElementById('monto').value;
  if(!origen || !destino || !montoRaw){
    alert('Completa origen, destino y monto antes de pedir el servicio.');
    return;
  }
  // prefer last calc if matches
  let recibeTxt = '';
  if(window._lastCalc && window._lastCalc.origen === origen && window._lastCalc.destino === destino && Number(window._lastCalc.monto) === Number(montoRaw)){
    recibeTxt = formatNumber(window._lastCalc.recibe);
  } else {
    const match = findRateFor(origen, destino);
    if(!match || match.reversed){
      alert('No hay tasa detectada para esta ruta. Verifica la hoja.');
      return;
    }
    recibeTxt = formatNumber(Number(montoRaw) * match.price);
  }
  const tasaVal = (rates[`${origen}|||${destino}`] !== undefined) ? rates[`${origen}|||${destino}`] : 'N/D';
  const msg = `Hola, quiero hacer el cambio:\nEnviar: ${Number(montoRaw).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} (${origen})\nRecibir: ${recibeTxt} (${destino})\nRuta: ${origen} ‚Üí ${destino}\nTasa (Venta IMAD): ${tasaVal}\nMuchas gracias.`;
  window.open(TELEGRAM_LINK + '?text=' + encodeURIComponent(msg), '_blank');
}

/* radar background */
(function radar(){
  const canvas = document.getElementById('radarBG');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  function fit(){ const dpr = devicePixelRatio || 1; canvas.width = canvas.offsetWidth * dpr; canvas.height = canvas.offsetHeight * dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
  fit(); window.addEventListener('resize', fit);
  let t=0;
  function draw(){
    const w = canvas.offsetWidth, h = canvas.offsetHeight;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx = w * 0.16, cy = h * 0.16;
    for(let i=0;i<6;i++){
      ctx.beginPath();
      ctx.strokeStyle = `rgba(0,208,255,${0.02 + i*0.005})`;
      ctx.lineWidth = 1;
      const r = 40 + i*70 + (t%80);
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();
    }
    const ang = (t/30)%360 * Math.PI/180;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,260, ang-0.22, ang+0.22);
    ctx.closePath();
    ctx.fillStyle = 'rgba(0,208,255,0.02)';
    ctx.fill();
    t += 1.1;
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

/* attach events */
document.getElementById('btnCalcular').addEventListener('click', onCalculate);
document.getElementById('btnPedido').addEventListener('click', onPedido);

/* init */
loadAndProcess();
</script>
</body>
</html>

